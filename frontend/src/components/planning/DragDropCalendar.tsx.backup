import React, { useState, useEffect, useMemo, useCallback } from 'react';
import {
  DndContext,
  DragOverlay,
  useDraggable,
  useDroppable,
  DragStartEvent,
  DragEndEvent,
  DragOverEvent,
  pointerWithin,
  rectIntersection,
} from '@dnd-kit/core';
import { format, addDays, startOfWeek, endOfWeek, isSameDay, parseISO } from 'date-fns';
import { AllocationService } from '../../services/allocationService';
import { Button } from '../ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '../ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { Badge } from '../ui/badge';
import { cn } from '../../lib/utils';
import type { Allocation, Employee, Project } from '../../services/api';

interface AllocationConflict {
  employeeId: string;
  date: string;
  totalHours: number;
  capacity: number;
  conflicts: Allocation[];
}

interface CalendarData {
  allocations: Allocation[];
  employees: { id: string; name: string }[];
  projects: { id: string; name: string; clientName: string }[];
}

interface DragDropCalendarProps {
  startDate: string;
  endDate: string;
  projectFilter?: string;
  onAllocationCreated?: (allocation: Allocation) => void;
  onAllocationUpdated?: (allocation: Allocation) => void;
  onConflictDetected?: (conflicts: AllocationConflict[]) => void;
  preventOverallocation?: boolean;
  className?: string;
}

interface DragItem {
  type: 'employee' | 'allocation';
  employeeId?: string;
  allocationId?: string;
  projectId?: string;
  data?: any;
}

interface DropZoneData {
  date: string;
  employeeId?: string;
  projectId?: string;
}

// Draggable Employee Component
const DraggableEmployee = ({ employee }: { employee: { id: string; name: string } }) => {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `employee-${employee.id}`,
    data: {
      type: 'employee',
      employeeId: employee.id,
    },
  });

  const style = transform ? {
    transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
  } : undefined;

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={cn(
        'p-2 bg-white border rounded-lg cursor-grab shadow-sm hover:shadow-md transition-shadow',
        isDragging && 'opacity-50'
      )}
    >
      <div className="text-sm font-medium">{employee.name}</div>
      <div className="text-xs text-gray-500">Available</div>
    </div>
  );
};

// Draggable Allocation Component
const DraggableAllocation = ({ allocation }: { allocation: Allocation }) => {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: `allocation-${allocation.id}`,
    data: {
      type: 'allocation',
      allocationId: allocation.id,
      allocation,
    },
  });

  const style = transform ? {
    transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
  } : undefined;

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={cn(
        'p-2 bg-blue-100 border border-blue-200 rounded cursor-grab text-xs',
        isDragging && 'opacity-50'
      )}
    >
      <div className="font-medium text-blue-800 truncate">
        {allocation.projectName}
      </div>
      <div className="text-blue-600">{allocation.allocatedHours}h</div>
    </div>
  );
};

// Droppable Calendar Cell Component
const DroppableCalendarCell = ({ 
  date, 
  employeeId, 
  allocations, 
  employee,
  onHover 
}: { 
  date: string; 
  employeeId?: string; 
  allocations: Allocation[];
  employee?: { id: string; name: string };
  onHover?: (allocation: Allocation | null) => void;
}) => {
  const { isOver, setNodeRef } = useDroppable({
    id: `cell-${date}-${employeeId || 'project'}`,
    data: {
      date,
      employeeId,
    },
  });

  const dayAllocations = allocations.filter(allocation => {
    const allocationStart = parseISO(allocation.startDate);
    const allocationEnd = parseISO(allocation.endDate);
    const cellDate = parseISO(date);
    
    return cellDate >= allocationStart && cellDate <= allocationEnd &&
           (!employeeId || allocation.employeeId === employeeId);
  });

  const totalHours = dayAllocations.reduce((sum, allocation) => sum + allocation.allocatedHours, 0);
  const isOverCapacity = totalHours > 8; // Assuming 8-hour workday

  return (
    <div
      ref={setNodeRef}
      className={cn(
        'min-h-[60px] border border-gray-200 p-1 relative',
        isOver && 'bg-blue-50 border-blue-300',
        isOverCapacity && 'bg-red-50'
      )}
      data-testid={`capacity-indicator-${date}-${employeeId}`}
    >
      {/* Capacity indicator */}
      <div className="absolute top-1 right-1 text-xs">
        <span className={cn(
          'px-1 py-0.5 rounded text-xs',
          isOverCapacity ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'
        )}>
          {totalHours}h
        </span>
      </div>

      {/* Allocations */}
      <div className="space-y-1 mt-4">
        {dayAllocations.map(allocation => (
          <div
            key={allocation.id}
            className="relative"
            onMouseEnter={() => onHover?.(allocation)}
            onMouseLeave={() => onHover?.(null)}
          >
            <DraggableAllocation allocation={allocation} />
          </div>
        ))}
      </div>

      {/* Drop zone indicator */}
      {isOver && (
        <div className="absolute inset-0 border-2 border-dashed border-blue-400 bg-blue-50/50 flex items-center justify-center">
          <div className="text-sm text-blue-600 font-medium">Drop here</div>
        </div>
      )}
    </div>
  );
};

export const DragDropCalendar: React.FC<DragDropCalendarProps> = ({
  startDate,
  endDate,
  projectFilter,
  onAllocationCreated,
  onAllocationUpdated,
  onConflictDetected,
  preventOverallocation = false,
  className,
}) => {
  const [calendarData, setCalendarData] = useState<CalendarData>({
    allocations: [],
    employees: [],
    projects: [],
  });
  const [isLoading, setIsLoading] = useState(true);
  const [activeId, setActiveId] = useState<string | null>(null);
  const [hoveredAllocation, setHoveredAllocation] = useState<Allocation | null>(null);
  const [selectedProject, setSelectedProject] = useState<string>(projectFilter || 'all');

  // Generate date range
  const dateRange = useMemo(() => {
    const start = parseISO(startDate);
    const end = parseISO(endDate);
    const dates: Date[] = [];
    let current = start;
    
    while (current <= end) {
      dates.push(new Date(current));
      current = addDays(current, 1);
    }
    
    return dates;
  }, [startDate, endDate]);

  // Load calendar data
  const loadCalendarData = useCallback(async () => {
    try {
      setIsLoading(true);
      const filters = selectedProject !== 'all' ? { projectId: selectedProject } : {};
      const data = await AllocationService.getCalendarData(startDate, endDate, filters);
      setCalendarData(data);
    } catch (error) {
      console.error('Failed to load calendar data:', error);
    } finally {
      setIsLoading(false);
    }
  }, [startDate, endDate, selectedProject]);

  useEffect(() => {
    loadCalendarData();
  }, [loadCalendarData]);

  // Handle drag start
  const handleDragStart = (event: DragStartEvent) => {
    setActiveId(event.active.id as string);
  };

  // Handle drag end
  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveId(null);

    if (!over) return;

    const dragData = active.data.current as DragItem;
    const dropData = over.data.current as DropZoneData;

    if (!dragData || !dropData) return;

    try {
      if (dragData.type === 'employee') {
        // Create new allocation
        await handleCreateAllocation(dragData, dropData);
      } else if (dragData.type === 'allocation') {
        // Update existing allocation
        await handleUpdateAllocation(dragData, dropData);
      }
    } catch (error) {
      console.error('Failed to handle drag end:', error);
    }
  };

  // Create new allocation
  const handleCreateAllocation = async (dragData: DragItem, dropData: DropZoneData) => {
    if (!dragData.employeeId) return;

    const allocationData = {
      employeeId: dragData.employeeId,
      projectId: dragData.projectId || calendarData.projects[0]?.id || '1',
      startDate: dropData.date,
      endDate: dropData.date,
      allocatedHours: 8, // Default 8 hours
      status: 'active' as const,
      checkConflicts: preventOverallocation,
    };

    if (preventOverallocation) {
      const conflicts = await AllocationService.checkConflicts(allocationData);
      if (conflicts.length > 0) {
        onConflictDetected?.(conflicts);
        return;
      }
    }

    const result = await AllocationService.createAllocation(allocationData);
    
    if (result.conflicts && result.conflicts.length > 0) {
      onConflictDetected?.(result.conflicts);
    }

    onAllocationCreated?.(result.allocation);
    loadCalendarData();
  };

  // Update existing allocation
  const handleUpdateAllocation = async (dragData: DragItem, dropData: DropZoneData) => {
    if (!dragData.allocationId || !dragData.allocation) return;

    const allocation = dragData.allocation;
    const updates = {
      startDate: dropData.date,
      endDate: dropData.date,
      allocatedHours: allocation.allocatedHours,
    };

    const result = await AllocationService.bulkUpdateAllocations([
      {
        allocationId: dragData.allocationId,
        ...updates,
      },
    ]);

    if (result.conflicts && result.conflicts.length > 0) {
      onConflictDetected?.(result.conflicts);
    }

    if (result.updated.length > 0) {
      onAllocationUpdated?.(result.updated[0]);
    }

    loadCalendarData();
  };

  // Get active drag item
  const activeDragItem = useMemo(() => {
    if (!activeId) return null;

    if (activeId.startsWith('employee-')) {
      const employeeId = activeId.replace('employee-', '');
      const employee = calendarData.employees.find(e => e.id === employeeId);
      return employee ? <DraggableEmployee employee={employee} /> : null;
    }

    if (activeId.startsWith('allocation-')) {
      const allocationId = activeId.replace('allocation-', '');
      const allocation = calendarData.allocations.find(a => a.id === allocationId);
      return allocation ? <DraggableAllocation allocation={allocation} /> : null;
    }

    return null;
  }, [activeId, calendarData]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-500">Loading calendar...</div>
      </div>
    );
  }

  return (
    <div className={cn('h-full flex flex-col', className)}>
      {/* Header with filters */}
      <div className="flex items-center justify-between p-4 border-b">
        <h2 className="text-xl font-semibold">Resource Planning Calendar</h2>
        <div className="flex items-center gap-4">
          <Select value={selectedProject} onValueChange={setSelectedProject}>
            <SelectTrigger className="w-48" aria-label="Project filter">
              <SelectValue placeholder="Select project..." />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Projects</SelectItem>
              {calendarData.projects.map(project => (
                <SelectItem key={project.id} value={project.id}>
                  {project.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      </div>

      <DndContext
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
        collisionDetection={rectIntersection}
      >
        <div className="flex flex-1 overflow-hidden">
          {/* Employee Sidebar */}
          <div className="w-64 border-r bg-gray-50 p-4">
            <h3 className="font-medium mb-4">Available Employees</h3>
            <div className="space-y-2">
              {calendarData.employees.map(employee => (
                <DraggableEmployee key={employee.id} employee={employee} />
              ))}
            </div>
          </div>

          {/* Calendar Grid */}
          <div className="flex-1 overflow-auto">
            <div className="min-w-max">
              {/* Header row */}
              <div className="flex border-b bg-gray-50 sticky top-0 z-10">
                <div className="w-32 p-2 border-r font-medium">Employee</div>
                {dateRange.map(date => (
                  <div
                    key={date.toISOString()}
                    className="w-32 p-2 border-r text-center font-medium"
                  >
                    <div className="text-xs text-gray-500">
                      {format(date, 'EEE')}
                    </div>
                    <div>{format(date, 'MMM dd')}</div>
                  </div>
                ))}
              </div>

              {/* Employee rows */}
              {calendarData.employees.map(employee => (
                <div key={employee.id} className="flex border-b">
                  <div 
                    className="w-32 p-2 border-r bg-gray-50 font-medium"
                    data-testid={`employee-timeline-${employee.id}`}
                  >
                    {employee.name}
                  </div>
                  {dateRange.map(date => (
                    <div key={date.toISOString()} className="w-32">
                      <DroppableCalendarCell
                        date={date.toISOString().split('T')[0]}
                        employeeId={employee.id}
                        allocations={calendarData.allocations}
                        employee={employee}
                        onHover={setHoveredAllocation}
                      />
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>

        <DragOverlay>
          {activeDragItem}
        </DragOverlay>
      </DndContext>

      {/* Allocation details tooltip */}
      {hoveredAllocation && (
        <div className="absolute z-50 bg-black text-white p-2 rounded text-sm pointer-events-none">
          <div className="font-medium">{hoveredAllocation.employeeName}</div>
          <div>{hoveredAllocation.allocatedHours} hours/week</div>
          <div className="text-gray-300">{hoveredAllocation.role}</div>
        </div>
      )}
    </div>
  );
};

export default DragDropCalendar;